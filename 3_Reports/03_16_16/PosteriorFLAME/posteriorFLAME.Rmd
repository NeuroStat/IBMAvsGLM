---
title: "Posterior Distribution in FLAME"
author: "Han Bossier"
date: "24 maart 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Inference procedure in FLAME1

This report summarizes information that can be found in Woolrich et al. (2004). Typically, inference in neuro-imaging can be formulated in a problem of a group statistic being hierarchical. The different levels of the hierarchy are seperated by multiple GLMs at session level, subject level and finally group level. This is done because of computationally reasons. FSL incorporates a fully Bayesian framework to deal with inference on the multilevel GLM structure. 



### Level 1
At level one, the goal is to estimate $\beta_k$ and $\sigma^2_k$. For $k$ first level sessions. By applying Bayes theorem, we get:

$$ P(\beta_k,\sigma^2_k|Y_k) \propto P(Y_k|\beta_k,\sigma^2_k) \times P(\beta_k, \sigma^2_k) $$

With $P(\beta_k, \sigma^2_k)$ a prior in which a Berger-Bernando prior is chosen: ($1/\sigma^2_k$). \

As we are only interested in the $\beta$ parameters, we will margilize over $\sigma^2_k$:
$$ P(\beta_k|Y_k) \propto \int P(Y_k|\beta_k,\sigma^2_k)\frac{1}{\sigma^2_k} d\sigma^2_k $$

This corresponds to a multivariate non central t-distribution with $T-P_k$ degrees of freedom.

### Level 2
At level two, we will use the estimates from the first level. We now get:

$$ P(\beta_G,\sigma^2_g,\beta_k,\sigma^2_k|Y_k) \propto \prod_k^{N_k} \{P(Y_k|\beta_K,\sigma^2_k)\} \times P(\beta_k|\beta_G,\sigma^2_G) \times P(\beta_G,\sigma^2_G,\sigma^2_K)$$

However, as we are only interested in the second level parameters, we marginalise over $\beta_k$ and $\sigma^2_k$. Furthermore, as in the first level, we are most likely interested in the group parametere $\beta_G$, meaning we should marginalise over $\sigma_G$ as well. Unfortunately, this is analytically not possible. FSL uses a fast approximation (in FLAME1) to solve this problem. More specifically, we will assume that $P(\beta_G|Y)$ is a multivariate noncentral $t$ distribution:

$$ P(\beta_G|Y) \propto \int P(\beta_G, \sigma_G^2, \tau_k|Y)d\sigma^2_Gd\tau_K $$

$$ \approx T(\beta_G;\mu_{\beta_G},\sigma^2_G\sum_{\beta_G},v_{\beta_G}) $$

A fast approximation procedure is used to obtain point estimates for $\mu_{\beta_G},\sigma^2_G\sum_{\beta_G}$ and $v_{\beta_G}$ from previous equation. This leads to the expression that $P(\beta_G|Y)$ is by approximation a multivariate noncentral $t$ distribtution. However, the $dof$ are unknown. It is to be expected that the $dof$ be within the range $N_k - P_G \leq v \leq +\infty$. After some testing, it seems that by default the lower bound is used, leading to $dof = N_k - P_G$. For a one-sample $t$-test, this is the amount of subjects - 1.


Here we show this in R:

```{r}
##
###############
### Testing whether the UPPER limit or LOWER limit are being used in FLAME1
###############
##

library(oro.nifti)
nsub <- 100
DIM <- c(4,4,4)
  
# So FLAME1 uses a noncentral multivariate t-distribution approximation for inference at the second level.
# However, it is unclear how the DOF are calculated, the UPPER or the LOWER limit? This is needed to calculate p-maps. 
# We do not get a p-map from FSL. However, FSL does use a p-map as intermediate step when going from the t-map to a z-map. 
# So we will load in a z-map from an analysis. These z-maps are calculated through: t to p to z. So now we will go from z to p to t. And then try to calculate t to p, starting from t.

# Rounding digits
digRound <- 8
# Location:
testingStudy <- '/Volumes/2_TB_WD_Elements_10B8_Han/PhD/Simulation/Results/MAvsIBMA/1/SCEN_1/study1_stats'
zmap <- round(readNIfTI(paste(testingStudy,'/zstat1.nii',sep=''), verbose=FALSE, warn=-1, reorient=TRUE, call=NULL)[,,],digits=digRound)
tmap <- round(readNIfTI(paste(testingStudy,'/tstat1.nii',sep=''), verbose=FALSE, warn=-1, reorient=TRUE, call=NULL)[,,],digits=digRound)

# Lower limit of DOF = N-1
lowerDOF <- nsub-1
# Upper limit of DOF = +Inf
upperDOF <- Inf

# Start with the t-map we get from FSL, then calculate the p to z-map transformation and compare this with zmap from FSL.
LowerTrans <- round(array(qnorm(pt(tmap, df=lowerDOF)), dim=prod(DIM)),digits=digRound)
UpperTrans <- round(array(qnorm(pt(tmap, df=upperDOF)), dim=prod(DIM)),digits=digRound)
compTran <- data.frame(
  'True z-map' = array(zmap, dim=prod(DIM)),
  'Lower df' = LowerTrans,
  'Upper df' = UpperTrans,
  'Diff.z.low' = array(zmap, dim=prod(DIM)) - LowerTrans,
  'Diff.z.upp' = array(zmap, dim=prod(DIM)) - UpperTrans)
compTran


# ==> Probably the LOWER limit

```





